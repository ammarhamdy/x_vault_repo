
```
+---------------------------+   <== Application Layer
|       No ICMP here        |
+---------------------------+
|      Transport Layer      |   <== TCP / UDP (not used by ICMP)
|     (Not used by ICMP)    |
+---------------------------+
|      Network Layer        |   <== ICMP operates here!
|   +--------------------+  |
|   |   ICMP Message     |  |
|   +--------------------+  |
|   |      IP Header     |  |
+---------------------------+
|     Data Link Layer       |   <== Ethernet, Wi-Fi, etc.
+---------------------------+
|     Physical Layer        |
+---------------------------+
```


Internet Control Message Protocol (ICMP) is the utility protocol of TCP/IP, responsible for providing information regarding the availability of devices, services, or routes on a TCP/IP network.
Most network-troubleshooting techniques and tools center around common ICMP message types. 
ICMP is defined in `RFC 792`.


# ICMP Packet Structure

https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol

ICMP is part of IP, and it relies on IP to transmit its messages. 
ICMP contains a relatively small header that changes depending on its purpose.

ICMP header contains the following fields: 

```
+----------------+----------------+
|  Type (1 byte) | Code (1 byte)  |
+----------------+----------------+
|        Checksum (2 bytes)       |
+---------------------------------+
|       Identifier (2 bytes)      |
+---------------------------------+
|    Sequence Number (2 bytes)    |
+---------------------------------+
|      Data (variable size)       |
+---------------------------------+
```

![[Pasted image 20250127145849.png]]

**Type** 
	The type or classification of the ICMP message, based on the RFC specification 
- `8` = Echo Request
- `0` = Echo Reply

**Code** 
	The sub-classification of the ICMP message, based on the RFC specification 
	Always `0` for Echo Request

**Checksum**
	Used to ensure that the contents of the ICMP header and data are [intact upon arrival](https://translate.google.com/?sl=en&tl=ar&text=intact%20upon%20arrival&op=translate) .
	
**Variable** 
	A portion that varies depending on the Type and Code fields


# ICMP Types and Messages

As noted, the structure of an ICMP packet depends on its purpose, as defined by the values in the _Type_ and _Code_ fields.

==**You might consider the ICMP Type field the packetâ€™s classification and the Code field its subclass.**==

**For example**
A Type field value of 3 indicates â€œdestination unreachable.â€ While this information alone might not be enough to troubleshoot a problem, if that packet were also to specify a Code field value of 3, indicating â€œport unreachable,â€ you could conclude that there is an issue with the port with which you are attempting to communicate.

**For a full list of available ICMP types and codes, see**:
http://www.iana.org/assignments/icmp-parameters/.

# Echo Requests and Responses

ICMPâ€™s biggest claim to fame is the ping utility. 
Ping is used to test for connectivity to a device. 
While ping itself isnâ€™t a part of the ICMP spec, it utilizes ICMP to achieve its core functionality.


**round trip time** (or `RTT`), which is the time it takes for the packet to arrive and a response to be received

_The terms echo and ping are often used interchangeably, but remember that ping is actually the name of a tool._

**==echo reply matches the echo request in the previous packet.==**

```
The random text used in an ICMP echo request can be of great interest to a potential attacker.

Attackers can use the information in this padding to profile the operating system used on a device.

Additionally, attackers can place small bits of data in this field as a method of covert Ø³Ø±ÙŠ communication. 
```


# `traceroute`

The `traceroute` utility is used to identify the path from one device to another.

By using ICMP (with a little help from IP), `traceroute` can map the path packets take. 

For example, the first packet in the file `icmp_traceroute.pcapng` is pretty similar to the echo request.



# ICMP Version 6 (ICMPv6)

The updated version of IP relies heavily on ICMP for functions such as neighbor solicitation and path discovery.

`ICMPv6` was established with `RFC 4443` to support the feature set needed for IPv6, along with additional enhancements.

You can find a full list of the available types and codes from IANA here: 
http://www.iana.org/assignments/icmpv6-parameters/icmpv6-parameters.xhtml .


---
# Size of an ICMP Packet


### ðŸ“ Total Size of an ICMP Packet

The **total size of an ICMP packet** depends on:

1. The **ICMP header size** (fixed)
    
2. The **data/payload size** (variable)
    
3. Whether you're measuring the **ICMP portion only**, or the **entire IP packet** itâ€™s part of

### ðŸ”¹ 1. **ICMP Header Size**

The **standard ICMP header** (for Echo Request/Reply) is:

| Field | Size |
| --- | --- |
| Type | 1 byte |
| Code | 1 byte |
| Checksum | 2 bytes |
| Identifier | 2 bytes |
| Sequence Number | 2 bytes |
| **Total Header** | **8 bytes** |

### ðŸ”¹ 2. **Payload Size (Variable)**
* By default, tools like `ping` on Linux send **56 bytes** of data (not counting the 8-byte ICMP header).
* You can change this with the `-s` option in `ping`.
    

```bash
ping -s 100 8.8.8.8   # Sends 100 bytes of payload
```

### ðŸ”¹ 3. **IP Header Size**
* IP header is **20 bytes** (IPv4, without options).
* ICMP is encapsulated in an IP packet.
    

### ðŸ§® Total Size Examples

| Context | Size |
| --- | --- |
| ICMP header only | 8 bytes |
| ICMP (header + default ping payload) | 8 + 56 = **64 bytes** |
| Entire IPv4 packet (ping) | 20 (IP) + 64 (ICMP) = **84 bytes** |
| IPv6 adds a larger IP header | Usually **104 bytes total** or more |


### ðŸ” Real-World Example (using `ping`):
```bash
ping 8.8.8.8
```
Output may show:
```
64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=20.1 ms
```
That `64 bytes` includes the ICMP header and data **only**, not the IP header.

### âœ… Summary

| Component | Size |
| --- | --- |
| ICMP Header | 8 bytes |
| ICMP Default Payload (`ping`) | 56 bytes |
| IP Header | 20 bytes (IPv4) |
| **Total (ICMP)** | **64 bytes** |
| **Total (IP + ICMP)** | **84 bytes** |
