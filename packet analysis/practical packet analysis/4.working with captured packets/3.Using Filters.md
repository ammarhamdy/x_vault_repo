
A filter is an expression that defines criteria for the inclusion or exclusion of packets. 

If there are packets you don’t want to see, you can write a filter that gets rid of them.

**Capture filters** are specified when packets are being captured and will capture only those packets that are specified for inclusion/exclusion in the given expression.

**Display filters** are applied to an existing set of captured packets in order to hide unwanted packets or show desired packets based on the specified expression.


# Capture Filters
Capture filters are applied **==during==** the packet-capturing process to limit the packets delivered to the analyst from the start.

==One primary reason for using a capture filter is performance.==

To capture only the traffic on a specific port, you could use a capture filter.


To use the Capture Interfaces dialog as follows:
+ Choose the `Capture > options` button next to the interface on which you want to capture packets.
+ Find the interface you wish to use and scroll to the Capture Filter option in the far-right column.
+ You can apply the capture filter by clicking in this column to enter an expression
![[Pasted image 20250120131344.png]]


## Capture/BPF Syntax

Capture filters are applied by `libpcap`/`WinPcap` and use the Berkeley Packet Filter (`BPF`) syntax. This syntax is common in several packet-sniffing applications, mostly because packet-sniffing applications tend to rely on the `libpcap`/ `WinPcap` libraries, which allow for the use of `BPFs`.

A filter created using the `BPF` syntax is called an expression, and each expression consists of one or more _primitives_.
Primitives consist of one or more _qualifiers_ followed by an ID name or number.

![[Pasted image 20250120131841.png]]

### Hostname and Addressing Filters

```
dst host 192.168.0.10
```
This primitive alone is an expression that would capture traffic only with a destination IP address of `192.168.0.10`.

You can use logical operators (`&&`, `||`, `!`) to combine primitives to create more advanced expressions.

For example, the following expression will capture only traffic with a source IP address of `192.168.0.10` and a source or destination port of `80`:
```
src host 192.168.0.10 && port 80
```
You can do, for MAC = `00-1a-a0-52-e2-a0`:
```
ether host 00-1a-a0-52-e2-a0
```

```
host 2001:db8:85a3::8a2e:370:7334
```

You can also filter based on a device’s hostname with the host qualifier, like so:
```
host testserver2
```

### Port Filters
```
port 8080
!port 8080
dst port 80
```

### Protocol Filters
```
icmp
!ip6
```

### Protocol Field Filters

The advanced filters that we’ll discuss in this section will allow you to retrieve a specific 
number of bytes from a packet beginning at a particular location.

For example, suppose that we want to filter based on the type field of an ICMP header. 
The type field is located at the very beginning of a packet, which puts it at offset 0.

This specification will return a 1-byte integer value that we can compare against. 
For instance, to get only ICMP packets that represent destination unreachable (type 3) messages, we use the equal to operator in our filter expression:
```
icmp[0] == 3
```

To examine only ICMP packets that represent an echo request (type 8) or echo reply (type 0), use two primitives with the OR operator:
```
icmp[0] == 8 || icmp[0] == 0
```

==Use ping command on terminal and use this filter `icmp[0] == 3` to see on action.==

You can also specify the length of the data to be returned in your filter expression by appending the byte length after the offset number within the square brackets, separated by a colon.

For example, say we want to create a filter that captures all ICMP destination-unreachable, host-unreachable packets, identified by type 3, code. 
These are 1-byte fields, located next to each other at offset 0 of the packet header. 
To do this, we create a filter that checks 2 bytes of data beginning at offset 0 of the packet header, and we compare that data against the hex value `0301` (type 3, code 1), like this:
```
icmp[0:2] == 0x0301
```

A common scenario is to capture only TCP packets with the RST flag set.
You just need to know that the flags of a TCP packet are located at offset 13.
This is an interesting field because it is collectively 1 byte in size as the flags field, but each particular flag is identified by a single bit within this byte.

The bit the flag is stored in is specified by the number the bit represents, so the first bit would represent 1, the second 2, the third 4, and so on. Multiple flags can be set simultaneously in a TCP packet.
we must specify the location within the byte that we wish to examine by appending a single ampersand (&), followed by the number that represents where the flag is stored.

The RST flag is at the bit representing the number 4 within this byte, and the fact that this bit is set to 4 tells us that the RST flag is set.
```
tcp[13] & 4 == 4
```

To see all packets with the `PSH` flag set, which is identified by the bit location representing the number 8 in the TCP flags at offset 13, our filter would use that location instead:
```
tcp[13] & 8 == 8
```

#### Rest flag on TCP (RST)
In TCP (Transmission Control Protocol), **RST** refers to the **Reset** flag.
It is one of the control flags in the TCP header that signals the termination of a connection or the rejection of a packet. 
==**The RST flag is used to indicate an error or an abnormal condition in the TCP communication.**==

**Key Characteristics of the RST Flag**
1. **Immediate Termination**:
    - When a TCP segment with the RST flag set is sent, it immediately terminates the connection without going through the graceful **FIN** (finish) handshake.
2. **Connection Issues**:
    - Typically used when one side receives a packet that it cannot process or associate with an existing connection.
3. **No Acknowledgment**:
    - RST segments are not acknowledged, as they indicate an abnormal situation.

**When Is the RST Flag Used?**
1. **Connection Refused**:
    - If a server receives a packet for a port where no application is listening, it responds with an RST to reject the connection.
2. **Invalid Packet**:
    - If a host receives a packet that doesn’t match an established connection (e.g., unexpected sequence numbers or closed socket).
3. **Abrupt Termination**:
    - A host can send an RST to terminate the connection abruptly (e.g., due to an error or application crash).
4. **Firewall or IDS Behavior**:
    - Firewalls or Intrusion Detection Systems may generate RST packets to block unwanted connections.

**Troubleshooting and Observing RST**

```
tcpdump -i eth0 'tcp[tcpflags] & (tcp-rst) != 0'
```

```Wireshark
tcp.flags.reset == 1
```


### Sample Capture Filter Expressions

| Filter                          | Description                                    |     |
| ------------------------------- | ---------------------------------------------- | --- |
| `tcp[13] & 32 == 32`            | TCP packets with the URG flag set              |     |
| `tcp[13] & 16 == 16`            | TCP packets with the ACK flag set              |     |
| `tcp[13] & 8 == 8`              | TCP packets with the PSH flag set              |     |
| `tcp[13] & 4 == 4`              | TCP packets with the RST flag set              |     |
| `tcp[13] & 2 == 2`              | TCP packets with the SYN flag set              |     |
| `tcp[13] & 1 == 1`              | TCP packets with the FIN flag set              |     |
| `tcp[13] == 18`                 | TCP SYN-ACK packets                            |     |
| `ether host 00:00:00:00:00:00`  | Traffic to or from your MAC address            |     |
| `!ether host 00:00:00:00:00:00` | Traffic not to or from your MAC address        |     |
| `broadcast`                     | Broadcast traffic only                         |     |
| `icmp`                          | ICMP traffic                                   |     |
| `icmp[0:2] == 0x0301`           | ICMP destination unreachable, host unreachable |     |
| `ip`                            | IPv4 traffic only                              |     |
| `ip6`                           | IPv6 traffic only                              |     |
| `udp`                           | UDP traffic only                               |     |



----
# Display Filters

A display filter is one that, when applied to a capture file, tells Wireshark to display only packets that match that filter. 

You can enter a display filter in the Filter text box above the Packet List pane.

Display filters are used more often than capture filters because they allow you to filter the packet data you see without actually omitting the rest of the data in the capture file.

There are two ways to apply display filters. One is to apply them directly using the appropriate syntax.
Another is to use the Display Filter Expression dialog to build your filter iteratively.


## The Display Filter Expression Dialog
To access this dialog, click `Analyse > Display Filter Expression` on the  toolbar.


## The Filter Expression Syntax Structure

the syntax used for display filters follows a standard scheme and is easy to navigate. In most cases, this scheme is **==protocol-centric==** and follows the format `protocol.feature.subfeature`, as you saw when looking at the Display Filter Expression dialog.

Now suppose that you need to view only packets that are less than 128 bytes.
```
frame.len<=128
```

Say that you’re interested in displaying only packets to two IP addresses.
```
ip.addr==192.168.0.1 or ip.addr==192.168.0.2
```

Wireshark’s logical operators is (`and`, `or`, `xor`, `not`)


## Sample Display Filter Expressions

| Filter                             | Description                        |
| ---------------------------------- | ---------------------------------- |
| `!tcp.port==3389`                  | Filter out RDP traffic             |
| `tcp.flags.syn==1`                 | TCP packets with the SYN flag set  |
| `tcp.flags.reset==1`               | TCP packets with the RST flag set  |
| `!arp`                             | Clear ARP traffic                  |
| `http`                             | All HTTP traffic                   |
| `tcp.port==23` \|\| `tcp.port==21` | Telnet or FTP traffic              |
| `smtp` \|\|  `pop` \|\| `imap`     | Email traffic (SMTP, POP, or IMAP) |


For a complete list, see the Wireshark display filter reference at:
http://www.wireshark.org/docs/dfref/



---
# Saving Filters


## To save a custom capture filter, follow these steps:

Select `Capture > Capture Filters` to open the Capture Filter dialog.
Create a new filter by clicking the plus (+) button on the lower left side of the dialog.
Enter a name for your filter in the Filter Name box.
Enter the actual filter expression in the Filter String box.
Click the OK button to save your filter expression in the list.


## To save a custom display filter, follow these steps:

Type your filter into the Filter bar above the Packet List pane in the main window and click the ribbon button on the left side of the bar.

Click the Save this Filter option, and a list of saved display filters will be presented in a separate dialog.


# Adding Display Filters to a Toolbar

One of the easiest ways to interact with them is to add filter toggles to the Filter bar just above the Packet List pane. 
To do this, complete the following steps:

+ Type your filter into the Filter bar above the Packet List pane in the main window and click the plus (+) button on the right side of the bar.
+ A new bar will display below the Filter bar where you can provide a name for your filter in the Label, This is the label that will be used to represent the filter on the toolbar.