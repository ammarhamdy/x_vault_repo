# ARP Overview


## IPv4 and ARP:
+ If your network is using the IPv4 communications protocol, the Address Resolution Protocol, or ARP, is what you need to map IPv4 addresses to MAC addresses.
+ To send a packet to another host on the same *local* IPv4 network, a host must know the IPv4 address and the MAC address of the destination device.
+ A device uses Address Resolution Protocol (ARP) to determine the destination MAC address of a local device when it knows its IPv4 address.


## Functions of ARP:
+ ARP provides two basic functions:
	+ Resolving IPv4 addresses to MAC addresses.
	+ Maintaining a table of IPv4 to MAC address mappings.



---
# ARP Functions


## ARP table:
+ When a packet is sent to the data link layer to be encapsulated into an Ethernet frame, the device refers to a table in its memory to find the MAC address that is mapped to the IPv4 address. 
+ This table is stored temporarily in RAM memory and called the ARP table or the ARP cache.
+ The sending device will search its ARP table for a destination IPv4 address and a corresponding MAC address.


## How the device search for mac?
+ If the packet’s destination IPv4 address is on the same network as the source IPv4 address, the device will search the ARP table for the _destination IPv4 address_.
+ If the destination IPv4 address is on a different network than the source IPv4 address, the device will search the ARP table for _the IPv4 address of the default gateway_.
+ In both cases, the search is for an IPv4 address and a corresponding MAC address for the device.


## Send ARP request:
+ If the device locates the IPv4 address, its corresponding MAC address is used as the destination MAC address in the frame. If there is _no entry is found_, then the device sends an ARP request.
+ ![[ARP-Functions.gif]]



---
# ARP request


## When a device send ARP request:
+ An ARP request is sent when a device needs to determine the MAC address that is associated with an IPv4 address, and it does not have an entry for the IPv4 address in its ARP table.


## Content of ARP request:
+ ARP messages are encapsulated directly within an Ethernet frame.
+ There is no IPv4 header. 
+ The ARP request is encapsulated in an Ethernet frame using the following header information:
	+ _Destination MAC address_.
	+ _Source MAC address_.
	+ _Type_.


### Destination MAC address:
+ This is a broadcast address `FF-FF-FF-FF-FF-FF` requiring all Ethernet NICs on the LAN to accept and process the ARP request.


## Source MAC address:
+ This is MAC address of the sender of the ARP request.


## Type:
+ ARP messages have a type field of `0x806`. 
+ This informs the receiving NIC that the data portion of the frame needs to be passed to the ARP process.


## Travel of ARP request:
+ Because ARP requests are broadcasts, they are flooded out all ports by the switch, except the receiving port. 
+ All Ethernet NICs on the LAN process broadcasts and must deliver the ARP request to its operating system for processing. 
+ Every device must process the ARP request to see if the target IPv4 address matches its own. 
+ A *router* will not forward broadcasts out other interfaces.
+ Only one device on the LAN will have an IPv4 address that matches the target IPv4 address in the ARP request. 
+ All other devices will not reply.


## Video for arp request:
+ [youtube](https://youtu.be/dGTbwvhoHww).



---
# ARP Operation - ARP Reply


## ARP reply:
+ Only the device with the target IPv4 address associated with the ARP request will respond with an ARP reply. 
+ The ARP reply is encapsulated in an Ethernet frame using the following header information:
	+ *Destination MAC address*.
	+ *Source MAC address*.
	+ *Type*.


### Destination MAC address:
+ This is the MAC address of the sender of the ARP request.


### Source MAC address: 
+ This is the MAC address of the sender of the ARP reply.


### Type:
+ ARP messages have a type field of `0x806`. 
+ This informs the receiving NIC that the data portion of the frame needs to be passed to the ARP process.


## Travel of ARP request:
+ Only the device that originally sent the ARP request will receive the unicast ARP reply. 
+ After the ARP reply is received, the device will add the IPv4 address and the corresponding MAC address to its ARP table.
+ Packets destined for that IPv4 address can now be encapsulated in *frames* using its corresponding MAC address.
+ If no device responds to the ARP request, the packet is dropped because a frame cannot be created.


## Time stamped Entries:
+ Entries in the ARP table are time stamped (وقت مختوم). 
+ If a device does not receive a frame from a particular device before the timestamp expires, the entry for this device is removed from the ARP table.


## Static entries:
+ Static map entries can be entered in an ARP table, but this is rarely done. 
+ Static ARP table entries do not expire over time and must be manually removed.


## IPv6 neighbor discovery (ND):
+ IPv6 uses a similar process to ARP for IPv4, known as ICMPv6 Neighbor Discovery (ND).
+ IPv6 uses neighbor solicitation and neighbor advertisement messages, similar to IPv4 ARP requests and ARP replies.


## Vedio for ARP replay:
+ [youtube](https://youtu.be/dFEqT7hvBTA).



---
# ARP Role in Remote Communications


## Travel of the ARP request on remote:
+ When the destination IPv4 address is not on the same network as the source IPv4 address, the source device needs to send the frame to its default gateway. 
+ This is the interface of the local router.
+ Whenever a source device has a packet with an IPv4 address on another network, it will encapsulate that packet in a frame using the destination MAC address of the router.


## Travel for default gateway:
+ The IPv4 address of the default gateway is stored in the IPv4 configuration of the hosts. 
+ When a host creates a packet for a destination, it compares the destination IPv4 address and its own IPv4 address to determine if the two IPv4 addresses are located on the same Layer 3 network. 
+ If the destination host is not on its same network, the source checks its ARP table for an entry with the IPv4 address of the default gateway. 
+ If there is not an entry, it uses the ARP process to determine a MAC address of the default gateway.


## Vedio for ARP request on remote:
+ [youtube](https://youtu.be/5wpsNlP19QE).



---
# Removing Entries from an ARP Table


## Remove entries:
+ For each device, an ARP cache timer removes ARP entries that have not been used for a specified period of time. The times differ depending on the operating system of the device. 
+ For example, newer Windows operating systems store ARP table entries between 15 and 45 seconds.
+ Commands may also be used to manually remove some or all of the entries in the ARP table.
+ `arp -d` command to clear the ARP table.

---
# ARP Tables on Networking Devices


## On cisco router:
+ On a Cisco router, the `show ip arp` command is used to display the ARP table, as shown:
+ ![[Pasted image 20230413153409.png]]


## On windows 11:
+ On a Windows 11 PC, the `arp –a` command is used to display the ARP table, as shown:
+ ![[Pasted image 20230413153510.png]]



---
# ARP Issues - ARP Broadcasts and ARP Spoofing


## Problem of ARP broadcast:
+ As a broadcast frame, an ARP request is received and processed by every device on the local network. 
+ On a typical business network, these broadcasts would probably have minimal impact on network performance. 
+ After the devices send out the initial ARP broadcasts and have learned the necessary MAC addresses, any impact on the network will be minimized.


## Security risk of ARP:
+ In some cases, the use of ARP can lead to a potential security risk. 
+ A threat actor (ممثل التهديد) can use ARP spoofing (انتحال) to perform an **ARP poisoning attack**. 
+ This is a technique used by a threat actor to reply to an ARP request for an IPv4 address that belongs to another device, such as the default gateway. 
+ The threat actor sends an ARP reply with its own MAC address.
+ The receiver of the ARP reply will add the wrong MAC address to its ARP table and send these packets to the threat actor.
+ Enterprise level switches include mitigation techniques known as dynamic ARP inspection (DAI) that can solve this problem.
+ ![[Pasted image 20230413171319.png]]


## Dynamic ARP inspection:
+ [cisco docs]([Understanding and Configuring Dynamic ARP Inspection - Cisco](https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst4500/12-2/25ew/configuration/guide/conf/dynarp.html)).
+ ![[dynarp.pdf]]


---
# Practice


## Show mac address table on switch:
+ `show mac-address-table`
